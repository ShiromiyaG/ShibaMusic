name: Release APK on version bump

on:
  push:
    branches:
      - main
      - master
    paths:
      - app/build.gradle
  workflow_dispatch:

jobs:
  detect_version_change:
    name: Detect version bump
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.detect.outputs.changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect versionName change
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          before_sha="${{ github.event.before }}"
          if [[ -z "$before_sha" || "$before_sha" == "0000000000000000000000000000000000000000" ]]; then
            before_sha="$(git rev-list --max-parents=0 HEAD)"
          fi

          if git diff "$before_sha" "${{ github.sha }}" -- app/build.gradle | grep -q "versionName"; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

  build_and_release:
    name: Build APK and publish release
    needs: detect_version_change
    if: needs.detect_version_change.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Prepare Gradle
        run: chmod +x gradlew

      # Decodificar e preparar keystore
      - name: Setup keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/keystore.jks
          echo "KEYSTORE_FILE=../keystore.jks" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV

      - name: Extract version metadata
        id: version
        shell: bash
        run: |
          set -euo pipefail
          version_name="$(sed -n "s/^[[:space:]]*versionName[[:space:]]*['\"]\\([^'\"]*\\)['\"].*/\\1/p" app/build.gradle | head -n 1)"
          version_code="$(sed -n "s/^[[:space:]]*versionCode[[:space:]]*\\([0-9]*\\).*/\\1/p" app/build.gradle | head -n 1)"

          if [[ -z "$version_name" ]]; then
            echo "NÃ£o foi possÃ­vel extrair versionName de app/build.gradle" >&2
            exit 1
          fi

          echo "version_name=$version_name" >> "$GITHUB_OUTPUT"
          echo "version_code=$version_code" >> "$GITHUB_OUTPUT"
          echo "VERSION_NAME=$version_name" >> "$GITHUB_ENV"
          echo "VERSION_CODE=$version_code" >> "$GITHUB_ENV"

      # Build APK assinado
      - name: Build signed release APK
        run: |
          ./gradlew --stacktrace assembleRelease \
            -Pandroid.injected.signing.store.file=$KEYSTORE_FILE \
            -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$KEY_PASSWORD

      - name: Rename and prepare artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts
          
          # APK principal
          cp app/build/outputs/apk/release/app-release.apk "artifacts/ShibaMusic-${VERSION_NAME}.apk"
          
          # Gerar checksums
          cd artifacts
          sha256sum "ShibaMusic-${VERSION_NAME}.apk" > "ShibaMusic-${VERSION_NAME}.apk.sha256"
          
          # Info do build
          echo "Build Info:" > build-info.txt
          echo "Version: ${VERSION_NAME}" >> build-info.txt
          echo "Version Code: ${VERSION_CODE}" >> build-info.txt
          echo "Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> build-info.txt
          echo "Commit: ${{ github.sha }}" >> build-info.txt

      - name: Generate changelog
        id: changelog
        shell: bash
        run: |
          set -euo pipefail
          last_tag="$(git describe --tags --abbrev=0 2>/dev/null || true)"
          current_tag="v${VERSION_NAME}"

          if [[ -n "$last_tag" ]]; then
            range="${last_tag}..HEAD"
            compare_url="${{ github.server_url }}/${{ github.repository }}/compare/${last_tag}...${current_tag}"
          else
            range="HEAD"
            compare_url=""
          fi

          features=""
          fixes=""
          chores=""
          others=""

          while IFS= read -r summary; do
            [[ -z "$summary" ]] && continue
            lower_summary="$(echo "$summary" | tr '[:upper:]' '[:lower:]')"
            if [[ "$lower_summary" == feat* ]]; then
              features+="- ${summary}\n"
            elif [[ "$lower_summary" == fix* || "$lower_summary" == bugfix* ]]; then
              fixes+="- ${summary}\n"
            elif [[ "$lower_summary" == chore* || "$lower_summary" == refactor* || "$lower_summary" == build* || "$lower_summary" == ci* ]]; then
              chores+="- ${summary}\n"
            else
              others+="- ${summary}\n"
            fi
          done < <(git log --no-merges --pretty=format:'%s' "$range")

          {
            echo "## ðŸŽµ ShibaMusic ${VERSION_NAME}"
            echo
            echo "**Baixe o APK abaixo e instale no seu dispositivo Android.**"
            echo
            echo "### ðŸ“‹ InformaÃ§Ãµes da VersÃ£o"
            echo "- **VersÃ£o**: \`${VERSION_NAME}\`"
            if [[ -n "${VERSION_CODE}" ]]; then
              echo "- **CÃ³digo da VersÃ£o**: \`${VERSION_CODE}\`"
            fi
            echo "- **Data**: $(date -u '+%d/%m/%Y %H:%M UTC')"
            if [[ -n "$compare_url" ]]; then
              echo "- **Diff completo**: [$compare_url]($compare_url)"
            fi
            echo

            if [[ -n "$features" ]]; then
              echo "### âœ¨ Novidades"
              printf "%b" "$features"
              echo
            fi

            if [[ -n "$fixes" ]]; then
              echo "### ðŸ› CorreÃ§Ãµes"
              printf "%b" "$fixes"
              echo
            fi

            if [[ -n "$chores" ]]; then
              echo "### ðŸ› ï¸ Melhorias e ManutenÃ§Ã£o"
              printf "%b" "$chores"
              echo
            fi

            if [[ -n "$others" ]]; then
              echo "### ðŸ“¦ Outras AlteraÃ§Ãµes"
              printf "%b" "$others"
              echo
            fi

            if [[ -z "$features$fixes$chores$others" ]]; then
              echo "### ðŸ“ AlteraÃ§Ãµes"
              echo "Nenhuma alteraÃ§Ã£o de commit registrada desde a Ãºltima versÃ£o."
              echo
            fi

            echo "### ðŸ” VerificaÃ§Ã£o"
            echo "Verifique a integridade do arquivo usando o checksum SHA256 fornecido."
            echo
            echo "### ðŸ“± InstalaÃ§Ã£o"
            echo "1. Baixe o arquivo \`ShibaMusic-${VERSION_NAME}.apk\`"
            echo "2. Habilite \"Origens desconhecidas\" nas configuraÃ§Ãµes do Android"
            echo "3. Instale o APK"
            echo
            echo "---"
            echo "ðŸ¤– *Release gerado automaticamente*"
          } > release_notes.md

          echo "body_path=release_notes.md" >> "$GITHUB_OUTPUT"

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version_name }}
          name: ðŸŽµ ShibaMusic v${{ steps.version.outputs.version_name }}
          body_path: ${{ steps.changelog.outputs.body_path }}
          files: |
            artifacts/ShibaMusic-${{ steps.version.outputs.version_name }}.apk
            artifacts/ShibaMusic-${{ steps.version.outputs.version_name }}.apk.sha256
            artifacts/build-info.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Limpar keystore por seguranÃ§a
      - name: Cleanup keystore
        if: always()
        run: |
          rm -f app/keystore.jks
