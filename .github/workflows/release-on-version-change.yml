name: Release APK on version bump

on:
  push:
    branches:
      - main
      - master
    paths:
      - app/build.gradle
  workflow_dispatch:

jobs:
  detect_version_change:
    name: Detect version bump
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.detect.outputs.changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect versionName change
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          before_sha="${{ github.event.before }}"
          if [[ -z "$before_sha" || "$before_sha" == "0000000000000000000000000000000000000000" ]]; then
            before_sha="$(git rev-list --max-parents=0 HEAD)"
          fi

          if git diff "$before_sha" "${{ github.sha }}" -- app/build.gradle | grep -q "versionName"; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

  build_and_release:
    name: Build APK and publish release
    needs: detect_version_change
    if: needs.detect_version_change.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Setup Gradle Wrapper
        run: |
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            echo "Gradle wrapper not found, regenerating..."
            gradle wrapper --gradle-version 8.10.2
          fi
          
          chmod +x gradlew
          
          ./gradlew --version

      - name: Setup keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.jks
          echo "KEYSTORE_FILE=$(pwd)/keystore.jks" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV

      - name: Extract version metadata
        id: version
        shell: bash
        run: |
          set -euo pipefail
          version_name="$(sed -n "s/^[[:space:]]*versionName[[:space:]]*['\"]\\([^'\"]*\\)['\"].*/\\1/p" app/build.gradle | head -n 1)"
          version_code="$(sed -n "s/^[[:space:]]*versionCode[[:space:]]*\\([0-9]*\\).*/\\1/p" app/build.gradle | head -n 1)"

          if [[ -z "$version_name" ]]; then
            echo "Could not extract versionName from app/build.gradle" >&2
            exit 1
          fi

          echo "version_name=$version_name" >> "$GITHUB_OUTPUT"
          echo "version_code=$version_code" >> "$GITHUB_OUTPUT"
          echo "VERSION_NAME=$version_name" >> "$GITHUB_ENV"
          echo "VERSION_CODE=$version_code" >> "$GITHUB_ENV"

      - name: Build signed release APK
        run: |
          ./gradlew --stacktrace assembleRelease \
            -Pandroid.injected.signing.store.file=$KEYSTORE_FILE \
            -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$KEY_PASSWORD

      - name: Find and verify APK
        run: |
          echo "ðŸ” Looking for APK files..."
          
          # Look for all APKs
          echo "ðŸ“ All found APKs:"
          find . -name "*.apk" -type f 2>/dev/null || echo "No APK found"
          
          # Check output directory
          echo "ðŸ“‚ Contents of build/outputs directory:"
          find app/build/outputs -type f 2>/dev/null || echo "build/outputs directory does not exist"
          
          # Check complete structure
          echo "ðŸ—ï¸ Build directory structure:"
          ls -la app/build/ 2>/dev/null || echo "Build directory does not exist"

      - name: Rename and prepare artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts
          
          # Find the generated APK (may be in different location)
          APK_FILE=""
          
          # Possible APK locations
          POSSIBLE_LOCATIONS=(
            "app/build/outputs/apk/release/app-release.apk"
            "app/build/outputs/apk/shibamusicRelease/app-shibamusicRelease.apk"
            "app/build/outputs/apk/shibamusicRelease/app-shibamusicRelease-release.apk"
            "app/build/outputs/apk/shibamusic/release/app-shibamusic-release.apk"
          )
          
          # Search APK in known locations
          for location in "${POSSIBLE_LOCATIONS[@]}"; do
            if [ -f "$location" ]; then
              APK_FILE="$location"
              echo "âœ… APK found at: $APK_FILE"
              break
            fi
          done
          
          # If not found, look for any release APK
          if [ -z "$APK_FILE" ]; then
            echo "ðŸ” Looking for any release APK..."
            APK_FILE=$(find app/build -name "*release*.apk" -type f | head -1)
          fi
          
          # If still not found, look for any APK
          if [ -z "$APK_FILE" ]; then
            echo "ðŸ” Looking for any APK..."
            APK_FILE=$(find app/build -name "*.apk" -type f | head -1)
          fi
          
          if [ -z "$APK_FILE" ] || [ ! -f "$APK_FILE" ]; then
            echo "âŒ No APK was found!"
            echo "ðŸ“‹ Listing all contents of app/build:"
            find app/build -type f -name "*.apk" 2>/dev/null || echo "No APK files exist"
            exit 1
          fi
          
          echo "ðŸ“± Copying APK: $APK_FILE"
          cp "$APK_FILE" "artifacts/ShibaMusic-${VERSION_NAME}.apk"
          
          # Generate checksums
          cd artifacts
          sha256sum "ShibaMusic-${VERSION_NAME}.apk" > "ShibaMusic-${VERSION_NAME}.apk.sha256"
          
          # Build info
          APK_SIZE=$(stat -c%s "ShibaMusic-${VERSION_NAME}.apk" 2>/dev/null | numfmt --to=iec 2>/dev/null || echo "Unknown")
          
          cat > build-info.txt << EOF
          Build Info:
          Version: ${VERSION_NAME}
          Version Code: ${VERSION_CODE}
          Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Commit: ${{ github.sha }}
          APK Size: ${APK_SIZE}
          APK Source: ${APK_FILE}
          EOF

          echo "âœ… Artifacts prepared:"
          ls -la

      - name: Generate changelog
        id: changelog
        shell: bash
        run: |
          set -euo pipefail
          last_tag="$(git describe --tags --abbrev=0 2>/dev/null || true)"
          current_tag="v${VERSION_NAME}"

          if [[ -n "$last_tag" ]]; then
            range="${last_tag}..HEAD"
            compare_url="${{ github.server_url }}/${{ github.repository }}/compare/${last_tag}...${current_tag}"
          else
            range="HEAD"
            compare_url=""
          fi

          features=""
          fixes=""
          chores=""
          others=""

          while IFS= read -r summary; do
            [[ -z "$summary" ]] && continue
            lower_summary="$(echo "$summary" | tr '[:upper:]' '[:lower:]')"
            if [[ "$lower_summary" == feat* ]]; then
              features+="- ${summary}\n"
            elif [[ "$lower_summary" == fix* || "$lower_summary" == bugfix* ]]; then
              fixes+="- ${summary}\n"
            elif [[ "$lower_summary" == chore* || "$lower_summary" == refactor* || "$lower_summary" == build* || "$lower_summary" == ci* ]]; then
              chores+="- ${summary}\n"
            else
              others+="- ${summary}\n"
            fi
          done < <(git log --no-merges --pretty=format:'%s' "$range")

          {
            echo "## ðŸŽµ ShibaMusic ${VERSION_NAME}"
            echo
            echo "**Download the APK below and install it on your Android device.**"
            echo
            echo "### ðŸ“‹ Version Information"
            echo "- **Version**: \`${VERSION_NAME}\`"
            if [[ -n "${VERSION_CODE}" ]]; then
              echo "- **Version Code**: \`${VERSION_CODE}\`"
            fi
            echo "- **Date**: $(date -u '+%Y-%m-%d %H:%M UTC')"
            if [[ -n "$compare_url" ]]; then
              echo "- **Full diff**: [$compare_url]($compare_url)"
            fi
            echo

            if [[ -n "$features" ]]; then
              echo "### âœ¨ New Features"
              printf "%b" "$features"
              echo
            fi

            if [[ -n "$fixes" ]]; then
              echo "### ðŸ› Fixes"
              printf "%b" "$fixes"
              echo
            fi

            if [[ -n "$chores" ]]; then
              echo "### ðŸ› ï¸ Improvements and Maintenance"
              printf "%b" "$chores"
              echo
            fi

            if [[ -n "$others" ]]; then
              echo "### ðŸ“¦ Other Changes"
              printf "%b" "$others"
              echo
            fi

            if [[ -z "$features$fixes$chores$others" ]]; then
              echo "### ðŸ“ Changes"
              echo "No commit changes recorded since the last release."
              echo
            fi

            echo "### ðŸ” Verification"
            echo "Check the integrity of the file using the provided SHA256 checksum."
            echo
            echo "### ðŸ“± Installation"
            echo "1. Download the file \`ShibaMusic-${VERSION_NAME}.apk\`"
            echo "2. Enable 'Unknown sources' in your Android settings"
            echo "3. Install the APK"
            echo
            echo "---"
            echo "ðŸ¤– *Release generated automatically*"
          } > release_notes.md

          echo "body_path=release_notes.md" >> "$GITHUB_OUTPUT"

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version_name }}
          name: ðŸŽµ ShibaMusic v${{ steps.version.outputs.version_name }}
          body_path: ${{ steps.changelog.outputs.body_path }}
          files: |
            artifacts/ShibaMusic-${{ steps.version.outputs.version_name }}.apk
            artifacts/ShibaMusic-${{ steps.version.outputs.version_name }}.apk.sha256
            artifacts/build-info.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup keystore
        if: always()
        run: |
          rm -f keystore.jks
